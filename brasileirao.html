<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brasileirão — Números Fieis - Corinthians</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #f1f1f3;
      color: #18181b;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }

    /* ── HEADER ──────────────────────────────────────────── */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      background: #fff; border-bottom: 1px solid #e4e4e7;
      padding: 0 28px; height: 58px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo { font-size: 1.05rem; font-weight: 900; letter-spacing: -0.5px; color: #18181b; }
    .logo span { color: #52525b; font-weight: 600; }
    .header-nav { display: flex; align-items: center; gap: 10px; }
    .btn-nav {
      color: #71717a; font-size: 0.8rem; text-decoration: none;
      border: 1px solid #d4d4d8; border-radius: 8px; padding: 6px 14px;
      transition: all 0.15s; white-space: nowrap;
    }
    .btn-nav:hover { color: #18181b; border-color: #a1a1aa; }
    .btn-nav.ativo { color: #18181b; border-color: #18181b; font-weight: 700; }

    /* ── LAYOUT ──────────────────────────────────────────── */
    main {
      padding-top: 90px; padding-bottom: 80px;
      max-width: 960px; margin: 0 auto;
      padding-left: 20px; padding-right: 20px;
    }

    section { margin-bottom: 48px; }

    .section-title {
      font-size: 0.65rem; font-weight: 700;
      letter-spacing: 2.5px; text-transform: uppercase;
      color: #a1a1aa; margin-bottom: 18px;
      padding-bottom: 10px; border-bottom: 1px solid #e4e4e7;
    }

    /* ── LOADING ─────────────────────────────────────────── */
    #loading {
      text-align: center; padding: 80px 20px;
      color: #a1a1aa; font-size: 0.85rem; letter-spacing: 2px;
    }
    .spinner {
      width: 32px; height: 32px; border: 3px solid #e4e4e7;
      border-top-color: #7c3aed; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── TOGGLE BUTTONS ──────────────────────────────────── */
    .toggle-group { display: flex; gap: 6px; flex-wrap: wrap; }
    .toggle-btn {
      background: #fff; border: 1px solid #d4d4d8;
      border-radius: 8px; padding: 7px 16px;
      font-size: 0.78rem; font-weight: 600; color: #71717a;
      cursor: pointer; transition: all 0.15s;
      font-family: 'Inter', sans-serif; line-height: 1;
    }
    .toggle-btn:hover { border-color: #a1a1aa; color: #18181b; }
    .toggle-btn.ativo {
      background: #18181b; border-color: #18181b; color: #fff;
    }
    .toggle-btn.titulo-ativo {
      background: #f59e0b; border-color: #d97706; color: #fff;
    }

    /* ── CHART CARD ──────────────────────────────────────── */
    .chart-card {
      background: #fff; border: 1px solid #e4e4e7;
      border-radius: 16px; padding: 28px 24px;
    }
    .chart-header {
      display: flex; justify-content: space-between;
      align-items: flex-start; margin-bottom: 22px;
      flex-wrap: wrap; gap: 14px;
    }
    .chart-title-block {}
    .chart-title {
      font-size: 0.9rem; font-weight: 800;
      letter-spacing: -0.3px; color: #18181b; margin-bottom: 4px;
    }
    .chart-subtitle {
      font-size: 0.7rem; color: #a1a1aa; font-weight: 500;
    }
    .chart-container { position: relative; height: 280px; }
    .chart-legend {
      display: flex; align-items: center; gap: 20px;
      margin-top: 18px; flex-wrap: wrap;
    }
    .legend-item {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.72rem; color: #71717a; font-weight: 500;
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
    }
    .legend-star {
      width: 12px; height: 12px;
      background: #f59e0b; border-radius: 2px;
      transform: rotate(45deg);
    }

    /* ── ERA STATS ────────────────────────────────────────── */
    .era-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
    }
    .era-stat-card {
      background: #fff; border: 1px solid #e4e4e7;
      border-radius: 14px; padding: 18px 16px;
    }
    .era-stat-valor {
      font-size: 2rem; font-weight: 900;
      letter-spacing: -1.5px; line-height: 1;
      color: #18181b; margin-bottom: 6px;
    }
    .era-stat-label {
      font-size: 0.6rem; font-weight: 700;
      letter-spacing: 1.8px; text-transform: uppercase;
      color: #a1a1aa;
    }
    .era-stat-card.destaque-aprov .era-stat-valor { color: #7c3aed; }
    .era-stat-card.destaque-v .era-stat-valor { color: #2563eb; }
    .era-stat-card.destaque-d .era-stat-valor { color: #dc2626; }
    .era-stat-card.destaque-gp .era-stat-valor { color: #7c3aed; }
    .era-stat-card.destaque-gc .era-stat-valor { color: #dc2626; }

    /* ── H2H GRID ────────────────────────────────────────── */
    .h2h-search-wrap {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 16px; flex-wrap: wrap;
    }
    #h2h-busca {
      background: #fff; color: #18181b; border: 1px solid #d4d4d8;
      border-radius: 10px; padding: 8px 14px; font-size: 0.85rem;
      cursor: text; font-family: 'Inter', sans-serif; outline: none;
      font-weight: 500; flex: 1; min-width: 180px; max-width: 320px;
    }
    #h2h-busca:focus { border-color: #7c3aed; }
    .h2h-sort-group { display: flex; gap: 6px; }
    .h2h-sort-btn {
      background: #fff; border: 1px solid #d4d4d8; border-radius: 8px;
      padding: 6px 12px; font-size: 0.72rem; font-weight: 600;
      color: #71717a; cursor: pointer; font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }
    .h2h-sort-btn:hover { color: #18181b; border-color: #a1a1aa; }
    .h2h-sort-btn.ativo { background: #18181b; border-color: #18181b; color: #fff; }

    .h2h-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
      gap: 10px;
    }
    .h2h-card {
      background: #fff; border: 1px solid #e4e4e7;
      border-radius: 14px; padding: 16px 18px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .h2h-card:hover {
      border-color: #a1a1aa;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    }
    .h2h-header {
      display: flex; justify-content: space-between;
      align-items: flex-start; margin-bottom: 10px;
    }
    .h2h-adv {
      font-size: 0.85rem; font-weight: 700;
      color: #18181b; letter-spacing: -0.2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 180px;
    }
    .h2h-aprov {
      font-size: 1.1rem; font-weight: 900;
      letter-spacing: -0.5px; color: #7c3aed;
      white-space: nowrap;
    }
    .h2h-record {
      display: flex; gap: 10px; margin-bottom: 10px; align-items: center;
    }
    .h2h-record-item {
      font-size: 0.72rem; font-weight: 700;
    }
    .h2h-record-item .val { font-size: 1rem; font-weight: 900; }
    .h2h-record-item.h2h-v .val { color: #2563eb; }
    .h2h-record-item.h2h-e .val { color: #9ca3af; }
    .h2h-record-item.h2h-d .val { color: #dc2626; }
    .h2h-record-item .lbl { color: #a1a1aa; font-size: 0.62rem; }
    .h2h-record-sep { color: #d4d4d8; font-weight: 300; }
    .h2h-jogos { font-size: 0.65rem; color: #a1a1aa; margin-left: auto; }

    .h2h-bar {
      height: 5px; border-radius: 3px;
      display: flex; overflow: hidden; gap: 1px;
    }
    .h2h-bar-seg { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
    .h2h-bar-v { background: #2563eb; }
    .h2h-bar-e { background: #d1d5db; }
    .h2h-bar-d { background: #dc2626; }

    .h2h-gols {
      display: flex; gap: 8px; margin-top: 8px;
      font-size: 0.65rem; color: #9ca3af;
    }
    .h2h-gols span { color: #71717a; font-weight: 600; }

    /* ── BADGE TÍTULO ─────────────────────────────────────── */
    .ano-badge-titulo {
      display: inline-flex; align-items: center; gap: 4px;
      background: #fef3c7; border: 1px solid #fcd34d;
      border-radius: 6px; padding: 2px 7px;
      font-size: 0.62rem; font-weight: 700; color: #92400e;
      margin-left: 6px; vertical-align: middle;
    }

    /* ── RESPONSIVO ──────────────────────────────────────── */
    @media (max-width: 640px) {
      main { padding-left: 14px; padding-right: 14px; }
      .chart-header { flex-direction: column; }
      .chart-container { height: 220px; }
      .era-stats-grid { grid-template-columns: repeat(3, 1fr); }
      .h2h-grid { grid-template-columns: 1fr; }
      .header-nav .btn-nav:not(:last-child) { display: none; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">Números Fieis <span>- Corinthians</span></div>
  <div class="header-nav">
    <a href="jogos.html" class="btn-nav">Jogos por Ano</a>
    <a href="dashboard.html" class="btn-nav">Dashboard</a>
    <a href="index.html" class="btn-nav">← Início</a>
  </div>
</header>

<main>
  <div id="loading">
    <div class="spinner"></div>
    Carregando dados...
  </div>

  <div id="conteudo" style="display:none">

    <!-- ── FILTROS DE ATALHO ───────────────────────────────── -->
    <section id="sec-filtros">
      <div class="section-title">Período de Análise</div>
      <div class="toggle-group" id="filtros-periodo">
        <button class="toggle-btn ativo" data-periodo="era" onclick="alterarPeriodo(this)">Toda a Era</button>
        <button class="toggle-btn titulo-ativo" data-periodo="titulos" onclick="alterarPeriodo(this)">Anos de Título ⭐</button>
        <button class="toggle-btn" data-periodo="ultimos5" onclick="alterarPeriodo(this)">Últimos 5 Anos</button>
      </div>
    </section>

    <!-- ── GRÁFICO DE PERFORMANCE ──────────────────────────── -->
    <section id="sec-grafico">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title-block">
            <div class="chart-title">Performance Histórica</div>
            <div class="chart-subtitle" id="chart-periodo-label">Brasileirão Série A · Era Pontos Corridos (2003–2026)</div>
          </div>
          <div class="toggle-group" id="toggles-metrica">
            <button class="toggle-btn ativo" data-metrica="aproveitamento" onclick="alterarMetrica(this)">% Aproveitamento</button>
            <button class="toggle-btn" data-metrica="pontos" onclick="alterarMetrica(this)">Total de Pontos</button>
            <button class="toggle-btn" data-metrica="gols" onclick="alterarMetrica(this)">Gols Pró</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="grafico-perf"></canvas>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background:#7c3aed"></div>
            Série A
          </div>
          <div class="legend-item">
            <div class="legend-star"></div>
            Título Conquistado
          </div>
          <div class="legend-item" id="legenda-serie-b" style="display:none">
            <div class="legend-dot" style="background:#d97706"></div>
            Série B
          </div>
        </div>
      </div>
    </section>

    <!-- ── RESUMO DO PERÍODO ───────────────────────────────── -->
    <section id="sec-resumo">
      <div class="section-title" id="resumo-titulo">Resumo da Era</div>
      <div class="era-stats-grid" id="era-stats"></div>
    </section>

    <!-- ── H2H ────────────────────────────────────────────── -->
    <section id="sec-h2h">
      <div class="section-title">Confronto Direto por Adversário</div>
      <div class="h2h-search-wrap">
        <input type="text" id="h2h-busca" placeholder="Buscar adversário…" oninput="filtrarH2H()" autocomplete="off">
        <div class="h2h-sort-group">
          <button class="h2h-sort-btn ativo" data-sort="jogos" onclick="reordenarH2H(this)">Por Jogos</button>
          <button class="h2h-sort-btn" data-sort="aproveitamento" onclick="reordenarH2H(this)">Por Aprovt.</button>
          <button class="h2h-sort-btn" data-sort="vitorias" onclick="reordenarH2H(this)">Por Vitórias</button>
        </div>
      </div>
      <div class="h2h-grid" id="h2h-grid"></div>
    </section>

  </div><!-- /#conteudo -->
</main>

<script>
const API_URL = "/api/dados";
const TITULOS = [2005, 2011, 2015, 2017];
const ANO_MIN = 2003;

let dadosTodos = [];
let dadosBrasileirao = [];
let periodoAtivo = 'era';
let metricaAtiva = 'aproveitamento';
let sortAtivo = 'jogos';
let h2hDados = [];
let grafico = null;

// ── Helpers (idênticos ao jogos.html) ────────────────────
function rNorm(v) {
  return (v || '').toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
}
function limpar(val) {
  if (val === null || val === undefined || val === '') return '';
  return String(val).normalize('NFC')
    .replace(/[\u00A0\u200B-\u200D\uFEFF\u2028\u2029\u0000-\u001F\u007F]/g, '')
    .replace(/\s+/g, ' ').trim();
}
function formatarData(valor) {
  if (!valor) return '';
  if (typeof valor === 'string' && valor.includes('/')) return valor;
  try {
    const d = new Date(valor);
    if (isNaN(d)) return valor;
    return String(d.getUTCDate()).padStart(2,'0') + '/' +
           String(d.getUTCMonth()+1).padStart(2,'0') + '/' + d.getUTCFullYear();
  } catch(e) { return valor; }
}
function normalizar(data) {
  return data.map(row => ({
    d:   formatarData(row["DATA"]),
    a:   row["ANO COMPETICAO"],
    m:   limpar(row["MANDO"]),
    p:   (row["GOL CORINTHIANS"] === "" ? "0" : row["GOL CORINTHIANS"]) + "x" +
         (row["GOL ADVERSARIO"] === "" ? "0" : row["GOL ADVERSARIO"]),
    r:   limpar(row["RESULTADO"]),
    adv: limpar(row["TIME ADVERSARIO"]),
    c:   limpar(row["COMPETIÇÃO"]),
    e:   limpar(row["ESTADIO"]),
    t:   limpar(row["TECNICO CORINTHIANS"]),
  }));
}

// ── Parsing de jogo ───────────────────────────────────────
function parseJogo(j) {
  const r = rNorm(j.r);
  const parts = (j.p || '0x0').split('x');
  const pro = parseInt(parts[0]) || 0;
  const con = parseInt(parts[1]) || 0;
  return { r, pro, con };
}

// ── Cálculo por ano ───────────────────────────────────────
function calcularPorAno(jogos) {
  const mapa = {};
  jogos.forEach(j => {
    const ano = parseInt(j.a);
    if (!mapa[ano]) mapa[ano] = { v:0, e:0, d:0, total:0, pts:0, gp:0, gc:0 };
    const { r, pro, con } = parseJogo(j);
    mapa[ano].gp += pro;
    mapa[ano].gc += con;
    mapa[ano].total++;
    if (r === 'VITORIA')     { mapa[ano].v++; mapa[ano].pts += 3; }
    else if (r === 'EMPATE') { mapa[ano].e++; mapa[ano].pts += 1; }
    else if (r === 'DERROTA') { mapa[ano].d++; }
  });
  return Object.entries(mapa)
    .sort((a,b) => parseInt(a[0]) - parseInt(b[0]))
    .map(([ano, s]) => ({
      ano: parseInt(ano), ...s,
      aproveitamento: s.total > 0 ? (s.pts / (s.total * 3) * 100) : 0,
    }));
}

// ── Cálculo agregado ──────────────────────────────────────
function calcularAgregado(jogos) {
  let v=0, e=0, d=0, total=0, pts=0, gp=0, gc=0;
  jogos.forEach(j => {
    const { r, pro, con } = parseJogo(j);
    gp += pro; gc += con; total++;
    if (r === 'VITORIA')     { v++; pts += 3; }
    else if (r === 'EMPATE') { e++; pts += 1; }
    else if (r === 'DERROTA') { d++; }
  });
  return { v, e, d, total, pts, gp, gc,
    aproveitamento: total > 0 ? (pts / (total * 3) * 100) : 0 };
}

// ── Cálculo H2H ───────────────────────────────────────────
function calcularH2H(jogos) {
  const mapa = {};
  jogos.forEach(j => {
    const adv = j.adv || 'Desconhecido';
    if (!mapa[adv]) mapa[adv] = { v:0, e:0, d:0, total:0, pts:0, gp:0, gc:0 };
    const { r, pro, con } = parseJogo(j);
    mapa[adv].gp += pro;
    mapa[adv].gc += con;
    mapa[adv].total++;
    if (r === 'VITORIA')     { mapa[adv].v++; mapa[adv].pts += 3; }
    else if (r === 'EMPATE') { mapa[adv].e++; mapa[adv].pts += 1; }
    else if (r === 'DERROTA') { mapa[adv].d++; }
  });
  return Object.entries(mapa).map(([adv, s]) => ({
    adv, ...s,
    aproveitamento: s.total > 0 ? (s.pts / (s.total * 3) * 100) : 0,
  }));
}

// ── Filtro de período ─────────────────────────────────────
function getAnosFiltro() {
  const anosDisponiveis = [...new Set(dadosBrasileirao.map(j => parseInt(j.a)))].filter(Boolean).sort();
  if (periodoAtivo === 'titulos') return TITULOS.filter(a => anosDisponiveis.includes(a));
  if (periodoAtivo === 'ultimos5') {
    const ultimo = anosDisponiveis[anosDisponiveis.length - 1];
    return anosDisponiveis.filter(a => a >= ultimo - 4);
  }
  return anosDisponiveis;
}

function getJogosFiltrados() {
  const anos = new Set(getAnosFiltro());
  return dadosBrasileirao.filter(j => anos.has(parseInt(j.a)));
}

// ── Renderização do gráfico ───────────────────────────────
function renderizarGrafico(porAno) {
  const anos = porAno.map(s => s.ano);
  const valorFn = {
    aproveitamento: s => parseFloat(s.aproveitamento.toFixed(1)),
    pontos:         s => s.pts,
    gols:           s => s.gp,
  };
  const valores = porAno.map(valorFn[metricaAtiva]);

  const isTitulo = anos.map(a => TITULOS.includes(a));
  const pontoCores = isTitulo.map(t => t ? '#f59e0b' : '#7c3aed');
  const pontoRaio  = isTitulo.map(t => t ? 8 : 4);
  const pontoBorda = isTitulo.map(t => t ? '#d97706' : '#5b21b6');

  const labels = anos.map(a => {
    const badge = TITULOS.includes(a) ? ' ⭐' : '';
    return a + badge;
  });

  const ctx = document.getElementById('grafico-perf').getContext('2d');

  // Gradiente de preenchimento
  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(124,58,237,0.18)');
  gradient.addColorStop(1, 'rgba(124,58,237,0)');

  const dataset = {
    label: metricaAtiva === 'aproveitamento' ? '% Aproveitamento' :
           metricaAtiva === 'pontos' ? 'Total de Pontos' : 'Gols Pró',
    data: valores,
    borderColor: '#7c3aed',
    backgroundColor: gradient,
    borderWidth: 2.5,
    fill: true,
    tension: 0.35,
    pointBackgroundColor: pontoCores,
    pointBorderColor: pontoBorda,
    pointBorderWidth: 2,
    pointRadius: pontoRaio,
    pointHoverRadius: isTitulo.map(t => t ? 11 : 7),
  };

  const yConfig = {
    aproveitamento: { min: 0, max: 100, suffix: '%' },
    pontos:         { min: 0, max: null, suffix: ' pts' },
    gols:           { min: 0, max: null, suffix: '' },
  }[metricaAtiva];

  if (grafico) { grafico.destroy(); }

  grafico = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [dataset] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#18181b',
          titleColor: '#f4f4f5',
          bodyColor: '#a1a1aa',
          padding: 12,
          cornerRadius: 10,
          titleFont: { family: 'Inter', weight: '700', size: 13 },
          bodyFont: { family: 'Inter', size: 11 },
          callbacks: {
            title: function(items) {
              const idx = items[0].dataIndex;
              const ano = anos[idx];
              return ano + (TITULOS.includes(ano) ? '  ⭐ Título' : '');
            },
            afterTitle: function(items) {
              const idx = items[0].dataIndex;
              const s = porAno[idx];
              return 'J ' + s.total + '  V ' + s.v + '  E ' + s.e + '  D ' + s.d;
            },
            label: function(item) {
              const idx = item.dataIndex;
              const s = porAno[idx];
              if (metricaAtiva === 'aproveitamento')
                return '  Aprovt: ' + s.aproveitamento.toFixed(1) + '%  (' + s.pts + '/' + (s.total*3) + ' pts)';
              if (metricaAtiva === 'pontos')
                return '  Pontos: ' + s.pts + ' de ' + (s.total*3) + ' possíveis';
              return '  Gols Pró: ' + s.gp + '  (Contra: ' + s.gc + ', Saldo: ' + (s.gp - s.gc < 0 ? '' : '+') + (s.gp - s.gc) + ')';
            },
          }
        },
      },
      scales: {
        x: {
          grid: { color: '#f0f0f2', drawBorder: false },
          ticks: {
            color: '#9ca3af', font: { family: 'Inter', size: 11 },
            maxRotation: 45, minRotation: 0,
          },
        },
        y: {
          min: yConfig.min,
          max: yConfig.max,
          grid: { color: '#e4e4e7', drawBorder: false },
          ticks: {
            color: '#9ca3af', font: { family: 'Inter', size: 11 },
            callback: v => v + yConfig.suffix,
          },
        },
      },
    },
  });
}

// ── Renderização do resumo ────────────────────────────────
function renderizarResumo(jogos) {
  const s = calcularAgregado(jogos);
  const saldo = s.gp - s.gc;
  const mediaAprov = s.total > 0 ? s.aproveitamento.toFixed(1) : '0.0';

  document.getElementById('era-stats').innerHTML = [
    { val: s.total,               lbl: 'Jogos',           cls: '' },
    { val: s.v,                   lbl: 'Vitórias',        cls: 'destaque-v' },
    { val: s.e,                   lbl: 'Empates',         cls: '' },
    { val: s.d,                   lbl: 'Derrotas',        cls: 'destaque-d' },
    { val: mediaAprov + '%',      lbl: 'Aproveitamento',  cls: 'destaque-aprov' },
    { val: s.pts,                 lbl: 'Pontos',          cls: '' },
    { val: s.gp,                  lbl: 'Gols Pró',        cls: 'destaque-gp' },
    { val: s.gc,                  lbl: 'Gols Contra',     cls: 'destaque-gc' },
    { val: (saldo >= 0 ? '+' : '') + saldo, lbl: 'Saldo de Gols', cls: saldo >= 0 ? 'destaque-v' : 'destaque-d' },
  ].map(item => `
    <div class="era-stat-card ${item.cls}">
      <div class="era-stat-valor">${item.val}</div>
      <div class="era-stat-label">${item.lbl}</div>
    </div>
  `).join('');
}

// ── Renderização H2H ─────────────────────────────────────
function sortH2H(lista, campo) {
  return [...lista].sort((a, b) => {
    if (campo === 'aproveitamento') return b.aproveitamento - a.aproveitamento;
    if (campo === 'vitorias') return b.v - a.v;
    return b.total - a.total;
  });
}

function renderizarH2H(lista) {
  if (lista.length === 0) {
    document.getElementById('h2h-grid').innerHTML =
      '<div style="color:#a1a1aa;font-size:0.82rem;padding:20px 0">Nenhum adversário encontrado.</div>';
    return;
  }
  document.getElementById('h2h-grid').innerHTML = lista.map(s => {
    const pctV = s.total > 0 ? (s.v / s.total * 100) : 0;
    const pctE = s.total > 0 ? (s.e / s.total * 100) : 0;
    const pctD = s.total > 0 ? (s.d / s.total * 100) : 0;
    const saldo = s.gp - s.gc;
    const saldoStr = (saldo >= 0 ? '+' : '') + saldo;
    return `
      <div class="h2h-card">
        <div class="h2h-header">
          <div class="h2h-adv" title="${s.adv}">${s.adv}</div>
          <div class="h2h-aprov">${s.aproveitamento.toFixed(0)}%</div>
        </div>
        <div class="h2h-record">
          <div class="h2h-record-item h2h-v">
            <span class="val">${s.v}</span>
            <span class="lbl"> V</span>
          </div>
          <span class="h2h-record-sep">·</span>
          <div class="h2h-record-item h2h-e">
            <span class="val">${s.e}</span>
            <span class="lbl"> E</span>
          </div>
          <span class="h2h-record-sep">·</span>
          <div class="h2h-record-item h2h-d">
            <span class="val">${s.d}</span>
            <span class="lbl"> D</span>
          </div>
          <div class="h2h-jogos">${s.total} jogos</div>
        </div>
        <div class="h2h-bar">
          <div class="h2h-bar-seg h2h-bar-v" style="width:${pctV.toFixed(1)}%"></div>
          <div class="h2h-bar-seg h2h-bar-e" style="width:${pctE.toFixed(1)}%"></div>
          <div class="h2h-bar-seg h2h-bar-d" style="width:${pctD.toFixed(1)}%"></div>
        </div>
        <div class="h2h-gols">
          <span>GP <span>${s.gp}</span></span>
          <span>GC <span>${s.gc}</span></span>
          <span>Saldo <span style="color:${saldo >= 0 ? '#2563eb' : '#dc2626'}">${saldoStr}</span></span>
        </div>
      </div>
    `;
  }).join('');
}

function filtrarH2H() {
  const termo = rNorm(document.getElementById('h2h-busca').value);
  const lista = sortH2H(h2hDados, sortAtivo).filter(s =>
    !termo || rNorm(s.adv).includes(termo)
  );
  renderizarH2H(lista);
}

function reordenarH2H(btn) {
  document.querySelectorAll('.h2h-sort-btn').forEach(b => b.classList.remove('ativo'));
  btn.classList.add('ativo');
  sortAtivo = btn.dataset.sort;
  filtrarH2H();
}

// ── Atualização geral ─────────────────────────────────────
function atualizar() {
  const anos = getAnosFiltro();
  const jogos = getJogosFiltrados();

  // Label do período
  const periodoLabels = {
    era:      `Brasileirão Série A · Era Pontos Corridos (${ANO_MIN}–${Math.max(...anos)})`,
    titulos:  'Brasileirão · Anos de Título — 2005, 2011, 2015, 2017',
    ultimos5: `Brasileirão · Últimos 5 Anos (${Math.min(...anos)}–${Math.max(...anos)})`,
  };
  document.getElementById('chart-periodo-label').textContent = periodoLabels[periodoAtivo];

  const resumoLabels = {
    era:      'Resumo da Era (2003–' + Math.max(...anos) + ')',
    titulos:  'Resumo dos Anos de Título',
    ultimos5: 'Resumo dos Últimos 5 Anos',
  };
  document.getElementById('resumo-titulo').textContent = resumoLabels[periodoAtivo];

  // Gráfico
  const porAno = calcularPorAno(jogos);
  renderizarGrafico(porAno);

  // Resumo
  renderizarResumo(jogos);

  // H2H
  h2hDados = calcularH2H(jogos);
  document.getElementById('h2h-busca').value = '';
  filtrarH2H();
}

// ── Event handlers ────────────────────────────────────────
function alterarPeriodo(btn) {
  document.querySelectorAll('#filtros-periodo .toggle-btn').forEach(b => {
    b.classList.remove('ativo', 'titulo-ativo');
  });
  const novo = btn.dataset.periodo;
  btn.classList.add(novo === 'titulos' ? 'titulo-ativo' : 'ativo');
  periodoAtivo = novo;
  atualizar();
}

function alterarMetrica(btn) {
  document.querySelectorAll('#toggles-metrica .toggle-btn').forEach(b => b.classList.remove('ativo'));
  btn.classList.add('ativo');
  metricaAtiva = btn.dataset.metrica;
  // Recriar gráfico com nova métrica, mantendo período
  const anos = new Set(getAnosFiltro());
  const jogos = dadosBrasileirao.filter(j => anos.has(parseInt(j.a)));
  const porAno = calcularPorAno(jogos);
  renderizarGrafico(porAno);
}

// ── Inicialização ─────────────────────────────────────────
async function iniciar() {
  try {
    let rawData = null;
    try {
      const cached = sessionStorage.getItem('nf_dados_cache');
      if (cached) rawData = JSON.parse(cached);
    } catch(e) { rawData = null; }

    if (!rawData) {
      const resp = await fetch(API_URL);
      const json = await resp.json();
      if (!json.data) throw new Error('Sem dados');
      rawData = json.data;
      try { sessionStorage.setItem('nf_dados_cache', JSON.stringify(rawData)); } catch(e) {}
    }

    dadosTodos = normalizar(rawData);

    // Filtra apenas Campeonato Brasileiro a partir de 2003
    dadosBrasileirao = dadosTodos.filter(j => {
      const comp = rNorm(j.c);
      const ano  = parseInt(j.a);
      return comp.includes('BRASILEIRO') && ano >= ANO_MIN;
    });

    if (dadosBrasileirao.length === 0) {
      document.getElementById('loading').innerHTML =
        'Nenhum dado de Campeonato Brasileiro encontrado na base.';
      return;
    }

    document.getElementById('loading').style.display = 'none';
    document.getElementById('conteudo').style.display = '';

    atualizar();

  } catch(err) {
    document.getElementById('loading').innerHTML = 'Erro ao carregar dados.';
    console.error(err);
  }
}

iniciar();
</script>
</body>
</html>
