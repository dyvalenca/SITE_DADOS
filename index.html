<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Almanaque do TimÃ£o</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0a0a0a;
      color: #e5e5e5;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      background: #000; border-bottom: 1px solid #1c1c1c;
      padding: 0 28px; height: 58px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo { font-size: 1.05rem; font-weight: 900; letter-spacing: -0.5px; color: #fff; }
    .logo span { color: #7c3aed; }
    .header-nav { display: flex; align-items: center; gap: 14px; }
    .btn-nav {
      color: #888; font-size: 0.8rem; text-decoration: none;
      border: 1px solid #2a2a2a; border-radius: 8px; padding: 6px 14px;
      transition: all 0.15s; white-space: nowrap;
    }
    .btn-nav:hover { color: #fff; border-color: #444; }
    #anoSel {
      background: #111; color: #fff; border: 1px solid #2a2a2a;
      border-radius: 8px; padding: 6px 10px; font-size: 0.8rem;
      cursor: pointer; font-family: 'Inter', sans-serif; outline: none;
    }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      padding-top: 90px; padding-bottom: 80px;
      max-width: 960px; margin: 0 auto;
      padding-left: 20px; padding-right: 20px;
    }

    section { margin-bottom: 48px; }

    .section-title {
      font-size: 0.65rem; font-weight: 700;
      letter-spacing: 2.5px; text-transform: uppercase;
      color: #444; margin-bottom: 18px;
      padding-bottom: 10px; border-bottom: 1px solid #1a1a1a;
    }

    /* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading {
      text-align: center; padding: 80px 20px;
      color: #444; font-size: 0.85rem; letter-spacing: 2px;
    }
    .spinner {
      width: 32px; height: 32px; border: 3px solid #1f1f1f;
      border-top-color: #7c3aed; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ EFICIÃŠNCIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .eficiencia-grid {
      display: grid; grid-template-columns: 220px 1fr; gap: 16px; align-items: stretch;
    }
    .card-aprov {
      background: #111; border: 1px solid #1c1c1c; border-radius: 16px;
      padding: 28px 24px; display: flex; flex-direction: column;
      align-items: center; justify-content: center; text-align: center;
    }
    .aprov-valor {
      font-size: 4rem; font-weight: 900; line-height: 1;
      letter-spacing: -4px; color: #fff;
    }
    .aprov-label {
      font-size: 0.62rem; font-weight: 700; letter-spacing: 2px;
      color: #444; text-transform: uppercase; margin-top: 8px;
    }
    .aprov-pts {
      font-size: 0.75rem; color: #555; margin-top: 6px;
    }
    .contadores-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
    }
    .contador-item {
      background: #111; border: 1px solid #1c1c1c;
      border-radius: 14px; padding: 18px 20px;
    }
    .contador-valor {
      font-size: 2.4rem; font-weight: 900; letter-spacing: -1.5px; line-height: 1;
    }
    .contador-label {
      font-size: 0.62rem; font-weight: 700; letter-spacing: 2px;
      text-transform: uppercase; color: #444; margin-top: 5px;
    }
    .contador-item.jogs .contador-valor { color: #fff; }
    .contador-item.vits .contador-valor { color: #22c55e; }
    .contador-item.emps .contador-valor { color: #6b7280; }
    .contador-item.ders .contador-valor { color: #ef4444; }

    /* â”€â”€ GOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gols-bar-card {
      background: #111; border: 1px solid #1c1c1c;
      border-radius: 14px; padding: 20px 22px; margin-bottom: 12px;
    }
    .gols-bar-labels {
      display: flex; justify-content: space-between;
      font-size: 0.78rem; font-weight: 600; margin-bottom: 10px;
    }
    .gols-bar-labels .gp { color: #7c3aed; }
    .gols-bar-labels .gc { color: #ef4444; }
    .gols-bar {
      height: 10px; background: #1a1a1a;
      border-radius: 5px; overflow: hidden; display: flex;
    }
    .bar-gp { background: #7c3aed; transition: width 0.5s ease; }
    .bar-gc { background: #ef4444; transition: width 0.5s ease; }
    .gols-metricas { display: flex; gap: 10px; flex-wrap: wrap; }
    .gol-metrica {
      background: #111; border: 1px solid #1c1c1c;
      border-radius: 12px; padding: 14px 18px; flex: 1; min-width: 130px;
    }
    .gol-metrica-valor { font-size: 1.7rem; font-weight: 900; letter-spacing: -0.5px; line-height: 1; }
    .gol-metrica-label {
      font-size: 0.62rem; font-weight: 700; letter-spacing: 1.5px;
      text-transform: uppercase; color: #444; margin-top: 5px;
    }
    .gol-metrica.media-gp .gol-metrica-valor { color: #7c3aed; }
    .gol-metrica.media-gc .gol-metrica-valor { color: #ef4444; }

    /* â”€â”€ TIMELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .timeline-wrap {
      border: 1px solid #1c1c1c; border-radius: 14px; overflow: hidden;
    }
    .timeline-item {
      display: grid;
      grid-template-columns: 88px 1fr auto 60px;
      gap: 12px; align-items: center;
      padding: 10px 16px;
      border-left: 3px solid #1c1c1c;
      border-bottom: 1px solid #111;
      font-size: 0.82rem;
      transition: background 0.1s;
    }
    .timeline-item:last-child { border-bottom: none; }
    .timeline-item:hover { background: #111; }
    .timeline-item.vitoria { border-left-color: #22c55e; }
    .timeline-item.empate  { border-left-color: #4b5563; }
    .timeline-item.derrota { border-left-color: #ef4444; }
    .tl-data { color: #555; font-size: 0.72rem; white-space: nowrap; }
    .tl-info { min-width: 0; }
    .tl-comp {
      font-size: 0.6rem; font-weight: 700; letter-spacing: 1.2px;
      text-transform: uppercase; color: #555;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .tl-adv {
      font-weight: 600; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis; color: #e5e5e5;
    }
    .tl-placar { font-weight: 900; font-size: 1rem; letter-spacing: -0.5px; color: #fff; white-space: nowrap; text-align: right; }
    .tl-mando {
      font-size: 0.6rem; font-weight: 700; padding: 3px 8px;
      border-radius: 5px; white-space: nowrap; text-align: center;
    }
    .tl-mando.casa { background: #14251a; color: #4ade80; }
    .tl-mando.fora { background: #141a2e; color: #818cf8; }

    /* â”€â”€ COMPETIÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .comp-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 10px;
    }
    .comp-card {
      background: #111; border: 1px solid #1c1c1c;
      border-radius: 12px; padding: 16px;
    }
    .comp-name {
      font-size: 0.72rem; font-weight: 700;
      color: #e5e5e5; margin-bottom: 8px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .comp-aprov {
      font-size: 1.9rem; font-weight: 900;
      letter-spacing: -1px; line-height: 1;
      color: #7c3aed; margin-bottom: 8px;
    }
    .comp-detail { display: flex; gap: 8px; flex-wrap: wrap; font-size: 0.68rem; color: #555; }
    .comp-detail .v { color: #22c55e; }
    .comp-detail .d { color: #ef4444; }
    .comp-detail .e { color: #6b7280; }

    /* â”€â”€ RESPONSIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .eficiencia-grid { grid-template-columns: 1fr; }
      .contadores-grid { grid-template-columns: repeat(4, 1fr); }
      .contador-item { padding: 12px 10px; }
      .contador-valor { font-size: 1.6rem; }
      .timeline-item { grid-template-columns: 72px 1fr auto; }
      .tl-mando { display: none; }
      main { padding-left: 14px; padding-right: 14px; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">Almanaque <span>do TimÃ£o</span></div>
  <div class="header-nav">
    <a href="dashboard.html" class="btn-nav">ðŸ“Š Dashboard</a>
    <select id="anoSel" onchange="carregarAno(this.value)"></select>
  </div>
</header>

<main>
  <div id="loading">
    <div class="spinner"></div>
    Carregando dados...
  </div>

  <!-- EFICIÃŠNCIA -->
  <section id="sec-eficiencia" style="display:none">
    <div class="section-title">Painel de EficiÃªncia</div>
    <div class="eficiencia-grid">
      <div class="card-aprov">
        <div class="aprov-valor" id="aproveitamento">â€“</div>
        <div class="aprov-label">Aproveitamento</div>
        <div class="aprov-pts" id="aprov-pts"></div>
      </div>
      <div class="contadores-grid">
        <div class="contador-item jogs">
          <div class="contador-valor" id="n-jogos">0</div>
          <div class="contador-label">Jogos</div>
        </div>
        <div class="contador-item vits">
          <div class="contador-valor" id="n-vits">0</div>
          <div class="contador-label">VitÃ³rias</div>
        </div>
        <div class="contador-item emps">
          <div class="contador-valor" id="n-emps">0</div>
          <div class="contador-label">Empates</div>
        </div>
        <div class="contador-item ders">
          <div class="contador-valor" id="n-ders">0</div>
          <div class="contador-label">Derrotas</div>
        </div>
      </div>
    </div>
  </section>

  <!-- GOLS -->
  <section id="sec-gols" style="display:none">
    <div class="section-title">BalanÃ§o de Gols</div>
    <div class="gols-bar-card">
      <div class="gols-bar-labels">
        <span class="gp">Gols PrÃ³ â€” <strong id="gp-val">0</strong></span>
        <span class="gc">Gols Contra â€” <strong id="gc-val">0</strong></span>
      </div>
      <div class="gols-bar">
        <div class="bar-gp" id="bar-gp" style="width:50%"></div>
        <div class="bar-gc" id="bar-gc" style="width:50%"></div>
      </div>
    </div>
    <div class="gols-metricas">
      <div class="gol-metrica">
        <div class="gol-metrica-valor" id="saldo-val" style="color:#22c55e">+0</div>
        <div class="gol-metrica-label">Saldo de Gols</div>
      </div>
      <div class="gol-metrica media-gp">
        <div class="gol-metrica-valor" id="media-gp-val">0.00</div>
        <div class="gol-metrica-label">MÃ©d. Gols PrÃ³ / Jogo</div>
      </div>
      <div class="gol-metrica media-gc">
        <div class="gol-metrica-valor" id="media-gc-val">0.00</div>
        <div class="gol-metrica-label">MÃ©d. Gols Contra / Jogo</div>
      </div>
    </div>
  </section>

  <!-- TIMELINE -->
  <section id="sec-timeline" style="display:none">
    <div class="section-title">Timeline de Resultados</div>
    <div class="timeline-wrap" id="timeline-lista"></div>
  </section>

  <!-- COMPETIÃ‡Ã•ES -->
  <section id="sec-comps" style="display:none">
    <div class="section-title">DistribuiÃ§Ã£o por CompetiÃ§Ã£o</div>
    <div class="comp-grid" id="comp-grid"></div>
  </section>
</main>

<script>
const API_URL = "/api/dados";
let dadosTodos = [];

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rNorm(v) {
  return (v || '').toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
}
function limpar(val) {
  if (val === null || val === undefined || val === '') return '';
  return String(val).normalize('NFC')
    .replace(/[\u00A0\u200B-\u200D\uFEFF\u2028\u2029\u0000-\u001F\u007F]/g, '')
    .replace(/\s+/g, ' ').trim();
}
function formatarData(valor) {
  if (!valor) return '';
  if (typeof valor === 'string' && valor.includes('/')) return valor;
  try {
    const d = new Date(valor);
    if (isNaN(d)) return valor;
    return String(d.getUTCDate()).padStart(2,'0') + '/' +
           String(d.getUTCMonth()+1).padStart(2,'0') + '/' + d.getUTCFullYear();
  } catch(e) { return valor; }
}
function parseDataBR(str) {
  if (!str) return new Date(0);
  const p = str.split('/');
  return p.length === 3 ? new Date(p[2], p[1]-1, p[0]) : new Date(str);
}
function normalizar(data) {
  return data.map(row => ({
    d:   formatarData(row["DATA"]),
    a:   row["ANO COMPETICAO"],
    m:   limpar(row["MANDO"]),
    p:   (row["GOL CORINTHIANS"] === "" ? "0" : row["GOL CORINTHIANS"]) + "x" +
         (row["GOL ADVERSARIO"] === "" ? "0" : row["GOL ADVERSARIO"]),
    r:   limpar(row["RESULTADO"]),
    adv: limpar(row["TIME ADVERSARIO"]),
    c:   limpar(row["COMPETIÃ‡ÃƒO"]),
  }));
}

// â”€â”€ InicializaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function iniciar() {
  try {
    const resp = await fetch(API_URL);
    const json = await resp.json();
    if (!json.data) throw new Error('Sem dados');
    dadosTodos = normalizar(json.data);

    const anos = [...new Set(dadosTodos.map(j => parseInt(j.a)))]
      .filter(Boolean).sort((a,b) => b-a);

    const sel = document.getElementById('anoSel');
    anos.forEach(ano => sel.add(new Option(ano, ano)));
    sel.value = anos[0];

    renderizar(dadosTodos.filter(j => parseInt(j.a) === anos[0]));
  } catch(err) {
    document.getElementById('loading').innerHTML = 'Erro ao carregar dados.';
    console.error(err);
  }
}

function carregarAno(ano) {
  const jogos = dadosTodos.filter(j => parseInt(j.a) === parseInt(ano));
  if (jogos.length > 0) { renderizar(jogos); return; }
  fetch(`${API_URL}?ano=${ano}`)
    .then(r => r.json())
    .then(json => { if (json.data) renderizar(normalizar(json.data)); })
    .catch(console.error);
}

// â”€â”€ RenderizaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderizar(jogos) {
  document.getElementById('loading').style.display = 'none';
  ['sec-eficiencia','sec-gols','sec-timeline','sec-comps'].forEach(id => {
    document.getElementById(id).style.display = '';
  });

  // â”€â”€ EstatÃ­sticas gerais
  let vits = 0, emps = 0, ders = 0, gp = 0, gc = 0, pts = 0;
  jogos.forEach(j => {
    const r = rNorm(j.r);
    const parts = (j.p || '0x0').split('x');
    const pro = parseInt(parts[0]) || 0;
    const con = parseInt(parts[1]) || 0;
    gp += pro; gc += con;
    if (r === 'VITORIA')  { vits++; pts += 3; }
    else if (r === 'EMPATE')   { emps++; pts += 1; }
    else if (r === 'DERROTA')  { ders++; }
  });
  const total = jogos.length || 1;
  const aprov = total > 0 ? ((pts / (total * 3)) * 100).toFixed(1) : '0.0';

  // EficiÃªncia
  document.getElementById('aproveitamento').textContent = aprov + '%';
  document.getElementById('aprov-pts').textContent = pts + ' pts de ' + (total * 3) + ' disputados';
  document.getElementById('n-jogos').textContent = jogos.length;
  document.getElementById('n-vits').textContent = vits;
  document.getElementById('n-emps').textContent = emps;
  document.getElementById('n-ders').textContent = ders;

  // Gols
  document.getElementById('gp-val').textContent = gp;
  document.getElementById('gc-val').textContent = gc;
  const totalG = gp + gc || 1;
  document.getElementById('bar-gp').style.width = ((gp / totalG) * 100).toFixed(1) + '%';
  document.getElementById('bar-gc').style.width = ((gc / totalG) * 100).toFixed(1) + '%';
  const saldo = gp - gc;
  const saldoEl = document.getElementById('saldo-val');
  saldoEl.textContent = (saldo >= 0 ? '+' : '') + saldo;
  saldoEl.style.color = saldo > 0 ? '#22c55e' : saldo < 0 ? '#ef4444' : '#6b7280';
  document.getElementById('media-gp-val').textContent = (gp / total).toFixed(2);
  document.getElementById('media-gc-val').textContent = (gc / total).toFixed(2);

  // Timeline â€” mais recente primeiro
  const sorted = [...jogos].sort((a,b) => parseDataBR(b.d) - parseDataBR(a.d));
  document.getElementById('timeline-lista').innerHTML = sorted.map(j => {
    const r = rNorm(j.r);
    const cl = r === 'VITORIA' ? 'vitoria' : r === 'EMPATE' ? 'empate' : 'derrota';
    const mandoNorm = rNorm(j.m);
    const isCasa = mandoNorm.includes('CASA') || mandoNorm === 'MANDANTE';
    return `<div class="timeline-item ${cl}">
      <span class="tl-data">${j.d}</span>
      <div class="tl-info">
        <div class="tl-comp">${j.c || 'â€”'}</div>
        <div class="tl-adv">${j.adv || 'â€”'}</div>
      </div>
      <span class="tl-placar">${j.p}</span>
      <span class="tl-mando ${isCasa ? 'casa' : 'fora'}">${isCasa ? 'Casa' : 'Fora'}</span>
    </div>`;
  }).join('');

  // CompetiÃ§Ãµes
  const comps = {};
  jogos.forEach(j => {
    const comp = j.c || 'Outros';
    if (!comps[comp]) comps[comp] = { v:0, e:0, d:0, pts:0, total:0 };
    const r = rNorm(j.r);
    comps[comp].total++;
    if (r === 'VITORIA')  { comps[comp].v++; comps[comp].pts += 3; }
    else if (r === 'EMPATE')   { comps[comp].e++; comps[comp].pts += 1; }
    else if (r === 'DERROTA')  { comps[comp].d++; }
  });
  const compsOrdenadas = Object.entries(comps).sort((a,b) => b[1].total - a[1].total);
  document.getElementById('comp-grid').innerHTML = compsOrdenadas.map(([comp, s]) => {
    const ap = s.total > 0 ? ((s.pts / (s.total * 3)) * 100).toFixed(0) : 0;
    return `<div class="comp-card">
      <div class="comp-name" title="${comp}">${comp}</div>
      <div class="comp-aprov">${ap}%</div>
      <div class="comp-detail">
        <span>J ${s.total}</span>
        <span class="v">V ${s.v}</span>
        <span class="e">E ${s.e}</span>
        <span class="d">D ${s.d}</span>
      </div>
    </div>`;
  }).join('');
}

iniciar();
</script>
</body>
</html>
